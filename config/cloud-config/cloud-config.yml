#cloud-config

# --- System updates ---
package_update: true
package_upgrade: true

packages:
  - fail2ban

# --- Users ---
users:
  - name: deployer
    groups: docker
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILJ71qLxlPTPkzEf6hRQgNJa2hXx6mnk56Xa7Y9lQV4p github-actions-deployer
    sudo: false

# --- SSH hardening ---
write_files:
  - path: /etc/ssh/sshd_config.d/hardening.conf
    content: |
      PasswordAuthentication no
      KbdInteractiveAuthentication no
      ChallengeResponseAuthentication no
      MaxAuthTries 3
      AllowTcpForwarding no
      X11Forwarding no
      AllowAgentForwarding no
      AllowUsers root deployer

# --- Services ---
runcmd:
  - groupadd -f docker
  - systemctl restart sshd
  - systemctl enable fail2ban
  - systemctl start fail2ban
